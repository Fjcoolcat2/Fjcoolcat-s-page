<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Tavern - Premium Minecraft Emporium</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* [Previous CSS remains exactly the same] */
        
        /* Add button focus/active states for better UX */
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains the same] -->

    <!-- Login Section -->
    <div class="login-section" id="loginSection">
        <div id="loginForm" class="login-form">
            <input type="text" id="usernameInput" placeholder="Username" required>
            <input type="text" id="discordInput" placeholder="Discord (e.g., user#1234)" required>
            <input type="text" id="minecraftInput" placeholder="Minecraft Username" required>
            <button type="button" class="btn-primary" id="enterShopBtn">Enter Shop</button>
        </div>
        
        <div id="userInfo" class="user-info">
            <div class="welcome-text">
                Welcome, <span class="username" id="currentUser"></span>
            </div>
            <div class="user-actions">
                <button class="btn-chat" onclick="openGlobalChat()">ðŸ’¬ Global Chat</button>
                <button class="btn-support" onclick="openSupportChat()">ðŸŽ« Support Chat</button>
                <button class="btn-bulk" onclick="openBulkModal()">ðŸ“¦ My Bulk Order</button>
                <button class="btn-danger" onclick="logout()">Exit</button>
            </div>
        </div>
    </div>

    <!-- [Rest of HTML remains the same] -->

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Move all JavaScript to the bottom and ensure proper loading

        /* =========================================================
           0. INITIAL SETUP
        ========================================================= */
        // Particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                p.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(p);
            }
        }

        // Data & State
        let items = JSON.parse(localStorage.getItem('tavernItems')) || [
            { id: 1, name: "Elytra", type: "item", location: "Floor 1", price: "40 d", stock: "in", tags: ["item", "Floor 1"] },
            { id: 2, name: "Heavy Core", type: "item", location: null, price: "18 db", stock: "out", tags: ["item"] }
        ];
        let currentUser = localStorage.getItem('tavernUser') || null;
        let userDiscord = localStorage.getItem('tavernDiscord') || '';
        let userMinecraft = localStorage.getItem('tavernMinecraft') || '';
        let userBulkOrder = JSON.parse(localStorage.getItem('tavernBulkOrder')) || [];
        let submittedOrders = JSON.parse(localStorage.getItem('tavernSubmittedOrders')) || [];
        let currentFilter = 'all';
        let currentChat = null;
        let currentSupportUser = null;
        let globalMessages = JSON.parse(localStorage.getItem('tavernGlobalChat')) || [];
        let supportChats = JSON.parse(localStorage.getItem('tavernSupportChats')) || {};
        let bannedUsers = JSON.parse(localStorage.getItem('tavernBanned')) || [];
        let mutedUsers = JSON.parse(localStorage.getItem('tavernMuted')) || [];

        /* =========================================================
           1. LOGIN / LOGOUT
        ========================================================= */
        window.onload = () => {
            createParticles();
            setupEventListeners();
            if (currentUser) restoreLogin();
            renderItems();
        };

        function setupEventListeners() {
            // Enter Shop button click
            document.getElementById('enterShopBtn').addEventListener('click', login);
            
            // Enter key on input fields
            ['usernameInput', 'discordInput', 'minecraftInput'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', e => {
                    if (e.key === 'Enter') login();
                });
            });
        }

        function restoreLogin() {
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('userInfo').classList.add('show');
            if (currentUser === 'FJ121') showStaffUI();
        }

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const discord = document.getElementById('discordInput').value.trim();
            const minecraft = document.getElementById('minecraftInput').value.trim();

            if (!username || !discord || !minecraft) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (bannedUsers.includes(username.toLowerCase())) {
                showToast('You are banned from this shop', 'error');
                return;
            }

            currentUser = username;
            userDiscord = discord;
            userMinecraft = minecraft;
            
            localStorage.setItem('tavernUser', currentUser);
            localStorage.setItem('tavernDiscord', userDiscord);
            localStorage.setItem('tavernMinecraft', userMinecraft);
            
            document.getElementById('currentUser').textContent = username;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('userInfo').classList.add('show');
            
            if (username === 'FJ121') {
                showStaffUI();
                showToast('Welcome, Shopkeeper!', 'success');
            } else {
                showToast(`Welcome to The Tavern, ${username}!`, 'success');
            }
            
            renderItems();
        }

        function logout() {
            if (!confirm('Exit your account? You will need to log in again.')) return;
            
            currentUser = null;
            userDiscord = '';
            userMinecraft = '';
            userBulkOrder = [];
            
            ['tavernUser', 'tavernDiscord', 'tavernMinecraft', 'tavernBulkOrder'].forEach(k => localStorage.removeItem(k));
            
            document.getElementById('usernameInput').value = '';
            document.getElementById('discordInput').value = '';
            document.getElementById('minecraftInput').value = '';
            
            document.getElementById('loginForm').style.display = 'grid';
            document.getElementById('userInfo').classList.remove('show');
            hideStaffUI();
            closeChat(); closeBulkModal();
            renderItems();
            showToast('You have exited your account', 'success');
        }

        function showStaffUI() {
            ['adminControls', 'statsBar', 'adminBulkOrders', 'supportList', 'bannedUsers'].forEach(id => document.getElementById(id).classList.add('show'));
            updateStats(); renderAdminOrders(); renderSupportList(); renderBannedList();
        }

        function hideStaffUI() {
            ['adminControls', 'statsBar', 'adminBulkOrders', 'supportList', 'bannedUsers'].forEach(id => document.getElementById(id).classList.remove('show'));
        }

        /* =========================================================
           2. ITEMS & STOCK EDITOR
        ========================================================= */
        function addItem() {
            if (currentUser !== 'FJ121') return;
            const name = document.getElementById('itemName').value.trim();
            const price = document.getElementById('itemPrice').value.trim();
            const type = document.getElementById('itemType').value;
            const location = document.getElementById('itemLocation').value;
            const stock = document.getElementById('itemStock').value;
            if (!name || !price) return showToast('Name and price required', 'error');

            const newItem = {
                id: Date.now(),
                name, type,
                location: location === 'Hidden' ? null : location,
                price, stock,
                tags: [type]
            };
            if (location && location !== 'Hidden') newItem.tags.push(location);

            items.push(newItem);
            localStorage.setItem('tavernItems', JSON.stringify(items));
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            renderItems(); updateStats();
            showToast('Item added', 'success');
        }

        function deleteItem(id) {
            if (currentUser !== 'FJ121') return;
            if (!confirm('Delete this item?')) return;
            items = items.filter(i => i.id !== id);
            localStorage.setItem('tavernItems', JSON.stringify(items));
            renderItems(); updateStats();
            showToast('Item deleted', 'success');
        }

        function updateItemStock(id, newStock) {
            if (currentUser !== 'FJ121') return;
            const item = items.find(i => i.id === id);
            if (!item) return;
            item.stock = newStock;
            localStorage.setItem('tavernItems', JSON.stringify(items));
            renderItems(); updateStats();
            showToast(`Stock â†’ ${newStock}`, 'success');
        }

        function updateStats() {
            if (currentUser !== 'FJ121') return;
            document.getElementById('totalItems').textContent = items.length;
            document.getElementById('inStockItems').textContent = items.filter(i => i.stock === 'in').length;
            document.getElementById('bulkRequests').textContent = submittedOrders.length;
            const total = items.reduce((sum, it) => sum + (parseFloat(it.price) || 0), 0);
            document.getElementById('totalValue').textContent = total + ' d';
        }

        function renderItems() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';
            let filtered = items;
            if (currentFilter === 'in') filtered = items.filter(i => i.stock === 'in');
            else if (currentFilter === 'out') filtered = items.filter(i => i.stock === 'out');
            else if (currentFilter === 'limited') filtered = items.filter(i => i.stock === 'limited');

            if (!filtered.length) {
                container.innerHTML = `<div class="empty-state" style="grid-column:1/-1;text-align:center;padding:60px;color:rgba(255,255,255,0.5)"><div style="font-size:4rem;margin-bottom:20px">ðŸ“­</div><p>No items found</p></div>`;
                return;
            }
            filtered.forEach(it => container.appendChild(createItemCard(it)));
        }

        function createItemCard(item) {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.id = `item-${item.id}`;

            const inBulk = userBulkOrder.find(b => b.id === item.id);
            const shulkers = inBulk ? inBulk.shulkers : 1;

            // Stock display + staff editor
            let stockHtml = `
                <div class="stock-status ${item.stock === 'in' ? 'in-stock' : item.stock === 'limited' ? 'in-stock' : 'out-of-stock'}">
                    ${item.stock === 'in' ? 'In Stock' : item.stock === 'limited' ? 'Limited Stock' : 'Out of Stock'}
                </div>`;
            if (currentUser === 'FJ121') {
                stockHtml += `
                    <div class="staff-stock-editor show">
                        <select class="staff-stock-select ${item.stock}" onchange="updateItemStock(${item.id}, this.value)">
                            <option value="in" ${item.stock === 'in' ? 'selected' : ''}>In Stock</option>
                            <option value="out" ${item.stock === 'out' ? 'selected' : ''}>Out of Stock</option>
                            <option value="limited" ${item.stock === 'limited' ? 'selected' : ''}>Limited</option>
                        </select>
                    </div>`;
            }

            div.innerHTML = `
                ${currentUser === 'FJ121' ? `<button class="delete-btn" onclick="deleteItem(${item.id})">Ã—</button>` : ''}
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="tags">
                        <span class="tag tag-item">${item.type}</span>
                        ${item.location ? `<span class="tag tag-floor">${item.location}</span>` : ''}
                        ${item.stock === 'limited' ? `<span class="tag tag-rarity">Limited</span>` : ''}
                    </div>
                </div>
                <div class="item-details">
                    <div class="price">${item.price}</div>
                    ${stockHtml}
                    ${currentUser && currentUser !== 'FJ121' ? `
                        <div class="shulker-selector" style="display:${inBulk ? 'flex' : 'none'};" id="shulker-${item.id}">
                            <span class="shulker-label">Shulkers:</span>
                            <input type="number" class="shulker-input" value="${shulkers}" min="1" max="64" onchange="updateShulkers(${item.id}, this.value)">
                        </div>
                        <button class="add-to-bulk ${inBulk ? 'added' : ''}" onclick="toggleBulkItem(${item.id}, this)">${inBulk ? 'âœ“ Added' : 'Add to Bulk'}</button>
                    ` : ''}
                </div>
            `;
            return div;
        }

        /* =========================================================
           5. BULK ORDER
        ========================================================= */
        function toggleBulkItem(itemId, btn) {
            if (!currentUser || currentUser === 'FJ121') return showToast('Customers only', 'error');
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            const existing = userBulkOrder.find(b => b.id === itemId);
            if (existing) {
                userBulkOrder = userBulkOrder.filter(b => b.id !== itemId);
                btn.textContent = 'Add to Bulk';
                btn.classList.remove('added');
                document.getElementById(`shulker-${itemId}`).style.display = 'none';
                showToast('Removed from bulk', 'success');
            } else {
                userBulkOrder.push({ id: itemId, shulkers: 1, name: item.name, price: item.price });
                btn.textContent = 'âœ“ Added';
                btn.classList.add('added');
                document.getElementById(`shulker-${itemId}`).style.display = 'flex';
                showToast('Added to bulk', 'success');
            }
            localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
        }

        function updateShulkers(itemId, val) {
            const it = userBulkOrder.find(b => b.id === itemId);
            if (it) {
                it.shulkers = Math.max(1, Math.min(64, parseInt(val) || 1));
                localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
            }
        }

        function openBulkModal() {
            if (!currentUser) return showToast('Log in first', 'error');
            if (currentUser === 'FJ121') return showToast('Staff cannot order', 'error');
            document.getElementById('bulkModal').classList.add('show');
            renderBulkModal();
        }

        function closeBulkModal() {
            document.getElementById('bulkModal').classList.remove('show');
        }

        function renderBulkModal() {
            const cont = document.getElementById('bulkModalContent');
            if (!userBulkOrder.length) {
                cont.innerHTML = `
                    <div class="empty-bulk">
                        <div class="empty-bulk-icon">ðŸ“­</div>
                        <p>Your bulk order is empty</p>
                        <p style="font-size:0.9rem;margin-top:10px">Add items from the shop to get started!</p>
                    </div>`;
                return;
            }
            let total = 0, html = '';
            userBulkOrder.forEach(b => {
                const shop = items.find(i => i.id === b.id);
                if (!shop) return;
                const priceNum = parseFloat(shop.price.replace(/[^0-9.]/g, '')) || 0;
                const sub = priceNum * 27 * b.shulkers;
                total += sub;
                html += `
                    <div class="bulk-item-row">
                        <div class="bulk-item-info">
                            <h4>${b.name}</h4>
                            <p>${shop.price} per item Ã— 27 Ã— ${b.shulkers} shulker(s) = ${sub} d</p>
                        </div>
                        <div class="bulk-item-actions">
                            <div class="shulker-count">
                                <span>Shulkers:</span>
                                <input type="number" value="${b.shulkers}" min="1" max="64" onchange="updateShulkers(${b.id}, this.value); renderBulkModal();">
                            </div>
                            <button class="btn-remove" onclick="removeFromBulk(${b.id})">Remove</button>
                        </div>
                    </div>`;
            });
            html += `
                <div class="bulk-total">
                    <h3>Total Order Value</h3>
                    <div class="bulk-total-amount">${total} d</div>
                </div>
                <button class="btn-submit-order" onclick="submitBulkOrder()">Submit Order</button>`;
            cont.innerHTML = html;
        }

        function removeFromBulk(id) {
            userBulkOrder = userBulkOrder.filter(b => b.id !== id);
            localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
            renderBulkModal(); renderItems();
        }

        function submitBulkOrder() {
            if (!userBulkOrder.length) return showToast('Empty order', 'error');
            const order = {
                user: currentUser, discord: userDiscord, minecraft: userMinecraft,
                items: [...userBulkOrder], timestamp: new Date().toISOString(), id: Date.now()
            };
            submittedOrders.push(order);
            localStorage.setItem('tavernSubmittedOrders', JSON.stringify(submittedOrders));
            userBulkOrder = []; localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
            renderBulkModal(); renderItems(); updateStats();
            showToast('Order submitted! Check Discord.', 'success');
            setTimeout(closeBulkModal, 1500);
        }

        function clearAllOrders() {
            if (!confirm('Clear ALL submitted orders?')) return;
            submittedOrders = []; localStorage.setItem('tavernSubmittedOrders', JSON.stringify(submittedOrders));
            renderAdminOrders(); updateStats();
            showToast('All orders cleared', 'success');
        }

        /* =========================================================
           6. CHAT SYSTEM
        ========================================================= */
        function openGlobalChat() {
            if (!currentUser) return showToast('Log in first', 'error');
            if (bannedUsers.includes(currentUser.toLowerCase())) return showToast('Banned from chat', 'error');
            currentChat = 'global'; currentSupportUser = null;
            document.getElementById('globalChatOverlay').classList.add('show');
            renderGlobalMessages();
            scrollToBottom('globalMessages');
            const muted = mutedUsers.includes(currentUser.toLowerCase());
            document.getElementById('globalInput').disabled = muted;
            document.getElementById('globalSendBtn').disabled = muted;
            document.getElementById('globalMutedBanner').style.display = muted ? 'block' : 'none';
        }

        function openSupportChat() {
            if (!currentUser) return showToast('Log in first', 'error');
            if (bannedUsers.includes(currentUser.toLowerCase())) return showToast('Banned from chat', 'error');
            currentChat = 'support'; currentSupportUser = currentUser;
            document.getElementById('supportChatOverlay').classList.add('show');
            document.getElementById('supportChatTitle').textContent = `Support - ${currentUser}`;
            if (!supportChats[currentUser]) supportChats[currentUser] = [];
            renderSupportMessages();
            scrollToBottom('supportMessages');
            const muted = mutedUsers.includes(currentUser.toLowerCase());
            document.getElementById('supportInput').disabled = muted;
            document.getElementById('supportSendBtn').disabled = muted;
            document.getElementById('supportMutedBanner').style.display = muted ? 'block' : 'none';
        }

        function openStaffSupportChat(username) {
            if (currentUser !== 'FJ121') return;
            currentChat = 'support'; currentSupportUser = username;
            document.getElementById('supportChatOverlay').classList.add('show');
            document.getElementById('supportChatTitle').textContent = `Support - ${username}`;
            if (!supportChats[username]) supportChats[username] = [];
            renderSupportMessages();
            scrollToBottom('supportMessages');
            document.getElementById('supportInput').disabled = false;
            document.getElementById('supportSendBtn').disabled = false;
            document.getElementById('supportMutedBanner').style.display = 'none';
        }

        function closeChat() {
            document.getElementById('globalChatOverlay').classList.remove('show');
            document.getElementById('supportChatOverlay').classList.remove('show');
            currentChat = null; currentSupportUser = null;
        }

        function sendGlobalMessage() {
            const input = document.getElementById('globalInput');
            const content = input.value.trim();
            if (!content || !currentUser || mutedUsers.includes(currentUser.toLowerCase())) return;
            const msg = { id: Date.now(), author: currentUser, content, timestamp: new Date().toISOString(), deleted: false, isStaff: currentUser === 'FJ121' };
            globalMessages.push(msg);
            localStorage.setItem('tavernGlobalChat', JSON.stringify(globalMessages));
            input.value = '';
            renderGlobalMessages();
            scrollToBottom('globalMessages');
        }

        function sendSupportMessage() {
            const input = document.getElementById('supportInput');
            const content = input.value.trim();
            if (!content || !currentUser || !currentSupportUser || mutedUsers.includes(currentUser.toLowerCase())) return;
            const msg = { id: Date.now(), author: currentUser, content, timestamp: new Date().toISOString(), deleted: false, isStaff: currentUser === 'FJ121' };
            if (!supportChats[currentSupportUser]) supportChats[currentSupportUser] = [];
            supportChats[currentSupportUser].push(msg);
            localStorage.setItem('tavernSupportChats', JSON.stringify(supportChats));
            input.value = '';
            renderSupportMessages();
            scrollToBottom('supportMessages');
            if (currentUser === 'FJ121') renderSupportList();
        }

        function renderGlobalMessages() {
            const box = document.getElementById('globalMessages');
            box.innerHTML = globalMessages.map(m => createMessageHTML(m, 'global')).join('');
        }

        function renderSupportMessages() {
            const box = document.getElementById('supportMessages');
            if (!currentSupportUser || !supportChats[currentSupportUser]) {
                box.innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.5);margin-top:40px">No messages yet. Start the conversation!</p>';
                return;
            }
            box.innerHTML = supportChats[currentSupportUser].map(m => createMessageHTML(m, 'support')).join('');
        }

        function createMessageHTML(msg, type, className = '') {
            const isStaffUser = currentUser === 'FJ121';
            const isOwn = msg.author === currentUser;
            const isStaffMsg = msg.isStaff || msg.author === 'FJ121';
            const time = new Date(msg.timestamp).toLocaleTimeString();
            let actions = '';
            if (isStaffUser && !msg.deleted && msg.author !== 'FJ121') {
                actions = `
                    <div class="message-actions">
                        <button class="msg-btn msg-btn-delete" onclick="deleteMessage('${type}', ${msg.id})">ðŸ—‘ Delete</button>
                        <button class="msg-btn msg-btn-mute" onclick="muteUser('${msg.author}')">ðŸ”‡ Mute</button>
                        <button class="msg-btn msg-btn-ban" onclick="banUser('${msg.author}')">ðŸš« Ban</button>
                    </div>`;
            }
            const authorDisplay = isStaffMsg ? '[STAFF]' : msg.author;
            const authorClass = isStaffMsg ? 'staff' : '';
            let cls = className || 'chat-message ' + (isOwn ? 'own' : 'other');
            if (msg.deleted) cls += ' deleted';
            else if (isStaffMsg) cls += ' staff-msg';
            return `
                <div class="${cls}" data-msg-id="${msg.id}">
                    <div class="message-header">
                        <span class="message-author ${authorClass}">${authorDisplay}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${msg.deleted ? '<em>Message deleted by moderator</em>' : escapeHtml(msg.content)}</div>
                    ${actions}
                </div>`;
        }

        function deleteMessage(type, msgId) {
            if (currentUser !== 'FJ121') return;
            if (type === 'global') {
                const m = globalMessages.find(x => x.id === msgId);
                if (m) { m.deleted = true; localStorage.setItem('tavernGlobalChat', JSON.stringify(globalMessages)); renderGlobalMessages(); }
            } else if (type === 'support' && currentSupportUser) {
                const chat = supportChats[currentSupportUser];
                const m = chat.find(x => x.id === msgId);
                if (m) { m.deleted = true; localStorage.setItem('tavernSupportChats', JSON.stringify(supportChats)); renderSupportMessages(); }
            }
            showToast('Message deleted', 'success');
        }

        function muteUser(username) {
            if (currentUser !== 'FJ121' || username === 'FJ121') return;
            if (!mutedUsers.includes(username.toLowerCase())) {
                mutedUsers.push(username.toLowerCase());
                localStorage.setItem('tavernMuted', JSON.stringify(mutedUsers));
                renderBannedList();
                showToast(`${username} muted`, 'success');
            }
        }

        function unmuteUser(username) {
            if (currentUser !== 'FJ121') return;
            mutedUsers = mutedUsers.filter(u => u !== username.toLowerCase());
            localStorage.setItem('tavernMuted', JSON.stringify(mutedUsers));
            renderBannedList();
            showToast(`${username} unmuted`, 'success');
        }

        function banUser(username) {
            if (currentUser !== 'FJ121' || username === 'FJ121') return;
            if (!bannedUsers.includes(username.toLowerCase())) {
                bannedUsers.push(username.toLowerCase());
                localStorage.setItem('tavernBanned', JSON.stringify(bannedUsers));
                if (!mutedUsers.includes(username.toLowerCase())) {
                    mutedUsers.push(username.toLowerCase());
                    localStorage.setItem('tavernMuted', JSON.stringify(mutedUsers));
                }
                renderBannedList();
                showToast(`${username} banned`, 'success');
            }
        }

        function unbanUser(username) {
            if (currentUser !== 'FJ121') return;
            bannedUsers = bannedUsers.filter(u => u !== username.toLowerCase());
            localStorage.setItem('tavernBanned', JSON.stringify(bannedUsers));
            renderBannedList();
            showToast(`${username} unbanned`, 'success');
        }

        function closeSupportTicket(username) {
            if (currentUser !== 'FJ121') return;
            if (!confirm(`Close ticket for ${username}?`)) return;
            delete supportChats[username];
            localStorage.setItem('tavernSupportChats', JSON.stringify(supportChats));
            if (currentSupportUser === username) closeChat();
            renderSupportList();
            showToast('Ticket closed', 'success');
        }

        function renderSupportList() {
            if (currentUser !== 'FJ121') return;
            const cont = document.getElementById('supportChatsContainer');
            const users = Object.keys(supportChats).filter(u => u !== 'FJ121');
            if (!users.length) {
                cont.innerHTML = '<p style="color:rgba(255,255,255,0.5);text-align:center;padding:40px">No support tickets</p>';
                return;
            }
            cont.innerHTML = users.map(user => {
                const msgs = supportChats[user];
                const last = msgs[msgs.length - 1];
                const unread = msgs.some(m => !m.isStaff && !m.read);
                return `
                    <div class="support-chat-item ${unread ? 'unread' : ''}">
                        <div class="support-user-info" onclick="openStaffSupportChat('${user}')" style="flex:1;cursor:pointer">
                            <h4>${user}</h4>
                            <p>${last ? last.content.substring(0, 50) + '...' : 'No messages'}</p>
                        </div>
                        <div class="support-meta">
                            <div class="support-time">${last ? new Date(last.timestamp).toLocaleTimeString() : ''}</div>
                            ${unread ? '<span class="support-badge">NEW</span>' : ''}
                            <button class="btn-close-ticket" onclick="event.stopPropagation(); closeSupportTicket('${user}')" title="Close Ticket">âœ• Close</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderBannedList() {
            if (currentUser !== 'FJ121') return;
            const cont = document.getElementById('bannedList');
            const banned = bannedUsers.length;
            const mutedOnly = mutedUsers.filter(u => !bannedUsers.includes(u));
            if (!banned && !mutedOnly.length) {
                cont.innerHTML = '<p style="color:rgba(255,255,255,0.5);text-align:center">No banned or muted users</p>';
                return;
            }
            let html = '';
            if (banned) {
                html += '<h4 style="color:#ff5252;margin-bottom:15px">ðŸš« Banned</h4>';
                html += bannedUsers.map(u => `
                    <div class="banned-item">
                        <span class="banned-name">${u}</span>
                        <button class="btn-unban" onclick="unbanUser('${u}')">Unban</button>
                    </div>`).join('');
            }
            if (mutedOnly.length) {
                html += '<h4 style="color:#ff9800;margin:20px 0 15px">ðŸ”‡ Muted Only</h4>';
                html += mutedOnly.map(u => `
                    <div class="banned-item">
                        <span class="banned-name" style="color:#ff9800">${u}</span>
                        <button class="btn-unban" onclick="unmuteUser('${u}')">Unmute</button>
                    </div>`).join('');
            }
            cont.innerHTML = html;
        }

        function renderAdminOrders() {
            if (currentUser !== 'FJ121') return;
            const cont = document.getElementById('adminBulkList');
            if (!submittedOrders.length) {
                cont.innerHTML = `
                    <div class="empty-orders">
                        <div style="font-size:4rem;margin-bottom:20px">ðŸ“­</div>
                        <p>No bulk orders yet</p>
                    </div>`;
                return;
            }
            cont.innerHTML = submittedOrders.map(order => {
                let itemsHtml = order.items.map(b => {
                    const shop = items.find(i => i.id === b.id);
                    const priceNum = parseFloat((shop?.price || '0').replace(/[^0-9.]/g, '')) || 0;
                    const sub = priceNum * 27 * b.shulkers;
                    return `
                        <div class="bulk-order-item">
                            <span class="bulk-item-name">${b.name}</span>
                            <span class="bulk-item-qty">${b.shulkers} shulkers (${sub} d)</span>
                        </div>`;
                }).join('');
                const total = order.items.reduce((sum, b) => {
                    const shop = items.find(i => i.id === b.id);
                    const priceNum = parseFloat((shop?.price || '0').replace(/[^0-9.]/g, '')) || 0;
                    return sum + (priceNum * 27 * b.shulkers);
                }, 0);
                return `
                    <div class="bulk-order-card">
                        <div class="bulk-order-header">
                            <div>
                                <div class="bulk-order-user">${order.user}</div>
                                <div style="color:rgba(255,255,255,0.6);font-size:0.85rem;margin-top:5px">MC: ${order.minecraft} | Discord: ${order.discord}</div>
                            </div>
                            <div class="bulk-order-time">${new Date(order.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="bulk-order-details">${itemsHtml}</div>
                        <div class="bulk-order-total">Total: ${total} d</div>
                    </div>`;
            }).join('');
        }

        /* =========================================================
           7. FILTER & UTILS
        ========================================================= */
        function filterItems(type) {
            currentFilter = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderItems();
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function scrollToBottom(id) {
            const el = document.getElementById(id);
            el.scrollTop = el.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
