<!-- Replace the existing toggleBulkItem function with this corrected version -->
<script>
function toggleBulkItem(itemId, btn) {
    if (!currentUser || currentUser === 'FJ121' || currentUser === 'mod121') return showToast('Customers only', 'error');
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    const existing = userBulkOrder.find(b => b.id === itemId);

    if (existing) {
        userBulkOrder = userBulkOrder.filter(b => b.id !== itemId);
        btn.textContent = 'Add to Bulk';
        btn.classList.remove('added');
        document.getElementById(`order-type-${itemId}`).classList.remove('show');
        document.getElementById(`order-summary-${itemId}`).style.display = 'none';
        showToast('Removed from bulk', 'success');
    } else {
        // Add item with default values
        userBulkOrder.push({ 
            id: itemId, 
            orderType: 'item', // Default to single items
            quantity: 1, // Default quantity
            name: item.name, 
            price: item.price 
        });
        btn.textContent = '‚úì Added';
        btn.classList.add('added');
        document.getElementById(`order-type-${itemId}`).classList.add('show');
        document.getElementById(`order-summary-${itemId}`).style.display = 'block';
        showToast('Added to bulk', 'success');
        
        // Initialize the display
        updateOrderDisplay(itemId);
    }
    localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
}

// Add this new function to update the order display
function updateOrderDisplay(itemId) {
    const inBulk = userBulkOrder.find(b => b.id === itemId);
    if (!inBulk) return;
    
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    
    const priceNum = parseFloat(item.price.replace(/[^0-9.]/g, '')) || 0;
    let totalPrice = 0;
    let unitDescription = '';
    
    // Calculate based on order type
    if (inBulk.orderType === 'item') {
        totalPrice = priceNum * inBulk.quantity;
        unitDescription = `${inBulk.quantity} item(s)`;
    } else if (inBulk.orderType === 'shulker') {
        totalPrice = priceNum * 27 * inBulk.quantity;
        unitDescription = `${inBulk.quantity} shulker(s) (${inBulk.quantity * 27} stacks)`;
    } else if (inBulk.orderType === 'stacks') {
        totalPrice = priceNum * inBulk.quantity;
        unitDescription = `${inBulk.quantity} stack(s)`;
    }
    
    // Update the summary display
    const summaryEl = document.getElementById(`order-summary-${itemId}`);
    if (summaryEl) {
        summaryEl.textContent = `Total: ${totalPrice} d (${unitDescription})`;
        summaryEl.style.display = 'block';
    }
}

// Fix the updateOrderType function
function updateOrderType(itemId, orderType) {
    const inBulk = userBulkOrder.find(b => b.id === itemId);
    if (inBulk) {
        inBulk.orderType = orderType;
        localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
        updateOrderDisplay(itemId); // Update the display
    }
}

// Fix the updateOrderQuantity function  
function updateOrderQuantity(itemId, quantity) {
    const inBulk = userBulkOrder.find(b => b.id === itemId);
    if (inBulk) {
        inBulk.quantity = Math.max(1, Math.min(64, parseInt(quantity) || 1));
        localStorage.setItem('tavernBulkOrder', JSON.stringify(userBulkOrder));
        updateOrderDisplay(itemId); // Update the display
    }
}
</script>

<!-- Also update the createItemCard function to properly initialize the order type selector -->
<script>
// Replace the createItemCard function with this improved version
function createItemCard(item) {
    const div = document.createElement('div');
    div.className = 'item-card';
    div.id = `item-${item.id}`;

    const inBulk = userBulkOrder.find(b => b.id === itemId);
    const orderType = inBulk ? inBulk.orderType : 'item';
    const quantity = inBulk ? inBulk.quantity : 1;

    // Stock display + staff editor
    let stockHtml = `
        <div class="stock-status ${item.stock === 'in' ? 'in-stock' : item.stock === 'limited' ? 'in-stock' : 'out-of-stock'}">
            ${item.stock === 'in' ? 'In Stock' : item.stock === 'limited' ? 'Limited Stock' : 'Out of Stock'}
        </div>`;
    if (currentUser === 'FJ121') {
        stockHtml += `
            <div class="staff-stock-editor-enhanced show">
                <select class="stock-status-dropdown ${item.stock}" id="stock-select-${item.id}">
                    <option value="in" ${item.stock === 'in' ? 'selected' : ''}>‚úÖ In Stock</option>
                    <option value="out" ${item.stock === 'out' ? 'selected' : ''}>‚ùå Out of Stock</option>
                    <option value="limited" ${item.stock === 'limited' ? 'selected' : ''}>‚ö†Ô∏è Limited</option>
                </select>
                <button class="btn-update-stock-enhanced" onclick="updateItemStockEnhanced(${item.id})">üîÑ Update</button>
            </div>`;
    }

    div.innerHTML = `
        ${currentUser === 'FJ121' ? `<button class="delete-btn" onclick="deleteItem(${item.id})">√ó</button>` : ''}
        <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="tags">
                <span class="tag tag-item">${item.type}</span>
                ${item.location ? `<span class="tag tag-floor">${item.location}</span>` : ''}
                ${item.stock === 'limited' ? `<span class="tag tag-rarity">Limited</span>` : ''}
            </div>
        </div>
        <div class="item-details">
            <div class="price">${item.price}</div>
            ${stockHtml}
            ${currentUser && currentUser !== 'FJ121' && currentUser !== 'mod121' ? `
                <!-- CUSTOMER ORDER TYPE SELECTION -->
                <div class="order-type-selector ${inBulk ? 'show' : ''}" id="order-type-${item.id}">
                    <select class="order-type-select" onchange="updateOrderType(${item.id}, this.value)">
                        <option value="item" ${orderType === 'item' ? 'selected' : ''}>üì¶ Item</option>
                        <option value="shulker" ${orderType === 'shulker' ? 'selected' : ''}>üì¶ Shulker</option>
                        <option value="stacks" ${orderType === 'stacks' ? 'selected' : ''}>üìö Stacks</option>
                    </select>
                    <input type="number" class="quantity-input" value="${quantity}" min="1" max="64" onchange="updateOrderQuantity(${item.id}, this.value)">
                </div>
                <div class="order-summary" id="order-summary-${item.id}" style="display:${inBulk ? 'block' : 'none'};">
                    <!-- This will be populated by updateOrderDisplay -->
                </div>
                <button class="add-to-bulk ${inBulk ? 'added' : ''}" onclick="toggleBulkItem(${item.id}, this)">${inBulk ? '‚úì Added' : 'Add to Bulk'}</button>
            ` : ''}
        </div>
    `;
    
    // Initialize display if item is in bulk
    if (inBulk) {
        setTimeout(() => updateOrderDisplay(item.id), 100);
    }
    
    return div;
}
</script>
